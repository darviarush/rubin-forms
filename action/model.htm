{% layout "index_" %}
{% title =%}Модель{% end %}

<script>
function ping(td, opt) {
	if(!opt) opt = {}
	var x = CRoot.wrap('<img ctype=loader src="img/intersection.gif">').css('position', 'absolute').prependTo(td)
	td._loader = x
	td.onComplete = function(r) { this._loader.free() }
	td.onLoad = (opt.onLoad || function(r) { this.toggleClass(['is', 'no']) })
	if(opt.onError) td.onError = opt.onError
	delete opt.onLoad
	delete opt.onError
	
	var tr = td.up()
	var tbody = tr.up()
	var is_tab = !tbody.id()
	td.ping(extend({
		method: td.hasClass("no")? 'save': 'erase',
		action: (is_tab? 'tab_perm': 'perm'),
		tab: tbody.attr('tab'),
		col: tr.attr('col'),
		role: td.attr('role'),
		perm: td.down().grep(function() { return this.element.nodeType === 3 }).text().trim()
	}, opt))
}

$(document).on("click", function(e) {
	var td = e.target(), role = td.attr("role")
	if(role) {
		if(role == "+") {
			td.onLoad = function(data) {
				this.byId('modal-fg-area').val(data)
				this.byId('modal').open()
				this.byId('modal-fg').line.val( td.attr("line") )
				this.byId('modal-fg').end.val( td.attr("end") )
				this.byId('modal-fg').onLoad = function() {
					this.byId('modal').close()
				}
			};
			td.ping({method: '+', tab: td.up().up().attr("tab")})
		} else if(/\b(?:noauth|user|self)\b/.test(role)) {
			ping(td)
		} else if(role == 'valid' || role == 'selfcol') {
			if(role == 'selfcol') { td.html(td.html().replace(/^self(?:: )?/, '')) }
			td.edit({line: 1})
			td.onBeforeEdit = function() {
				ping(this, {action: role, method: "save", perm: this._edit.val(), onLoad: function() { 
					var val = this._edit.val()
					if(role == 'selfcol') {
						if(val) { td.addClass('green'); td.removeClass('red') } else { td.removeClass('green'); td.addClass('red') }
						val = val? "self: "+val: "self"
					}
					this.val( val )
				} })
				return false
			};
		}
	}
})

$(document).on("mouseover", function(e) {
	var td = e.target(), com
	if(td && /^td|th$/i.test(td.tag()) && (com = td.down(0)).tag() == "#comment") {
		say(td.tooltip({html: com.free().text(), append: 'prepend', display: 1, pos: 'bottom'}).tooltip().className())
	}
})

</script>

<style>
table {border-collapse: collapse; }
.tab { margin-bottom: 150px }
.tab td, .tab th { border: solid 1px grey; text-align: center; cursor: default }
.green { background: ForestGreen; font-waight: 700; color: white }
.yellow { background: Orange; font-waight: 700; color: white }
.red { background: IndianRed; font-waight: 700; color: white }
.grey { background: lavender }
.w { width: 132px }
.oh { height: 1em; overflow: hidden }
.is { background: Honeydew; }
.no { background: Bisque; }

.upr {color: red; font-family: arial; font-weight: 900; }

.is_odd { background: GhostWhite }
.no_odd { background: lavender }

.click { cursor: pointer !important }

.c-tip { background: Cornsilk; border: solid 1px grey; padding: 4px; color: black }
.c-fg { padding: 40px; background: white; min-width: 800px; }
</style>

<div id=modal ctype=center-modal style='display:none'>
	<div id=modal-fg class=c-fg ctype="form" action="/model">
		<div style="float:right"><a id=modal-fg-save ctype="save" href="#">Сохранить</a></div>
		<input type="hidden" id=modal-fg-line>
		<input type="hidden" id=modal-fg-end>
		<textarea id=modal-fg-area style='width:700px; height:400px'></textarea>
	</div>
</div>

<center>

<table id=$*tables class=tab>
<tbody tab="$name">
	<tr><th rowspan=3 class="click $is_install:bool($is_sql:bool('is', 'no'), 'no')" role="+">$name
		<th colspan=12>Права
		<th rowspan=3 class=w>Валидаторы
		<th rowspan=3>SQL
		<th rowspan=2 class=w>Пакет
	<tr><th class="w red" colspan=4>noauth
		<th class="w yellow" colspan=4>user
		<th class="w click $selfcol:bool('green', 'red')" colspan=4 role=selfcol>self$selfcol:bool(": ")$selfcol
	<tr>
		<td role="noauth" class="click $noauth_view:bool('is', 'no')">view
		<td role="noauth" class="click $noauth_add:bool('is', 'no')">add
		<td role="noauth" class="click $noauth_edit:bool('is', 'no')">edit
		<td role="noauth" class="click $noauth_rm:bool('is', 'no')">rm
		<td role="user" class="click $user_view:bool('is', 'no')">view
		<td role="user" class="click $user_add:bool('is', 'no')">add
		<td role="user" class="click $user_edit:bool('is', 'no')">edit
		<td role="user" class="click $user_rm:bool('is', 'no')">rm
		<td role="self" class="click $self_view:bool('is', 'no')">view
		<td role="self" class="click $self_add:bool('is', 'no')">add
		<td role="self" class="click $self_edit:bool('is', 'no')">edit
		<td role="self" class="click $self_rm:bool('is', 'no')">rm
		
		<td class="click $package:bool('is', 'no')">$package
</tbody>

<tbody id=$*col tab="$name">
	<tr col="$name">
		<td class="$is_install:bool($is_sql:bool('is', 'no'), 'no')">$name
		<td class="click $noauth_view:bool('is', 'no')" role="noauth">view
		<td class="click $noauth_add:bool('is', 'no')" role="noauth">add
		<td class="click $noauth_edit:bool('is', 'no')" role="noauth">edit
		<td class="grey">rm
		<td class="click $user_view:bool('is', 'no')" role="user">view
		<td class="click $user_add:bool('is', 'no')" role="user">add
		<td class="click $user_edit:bool('is', 'no')" role="user">edit
		<td class="grey">rm
		<td class="click $self_view:bool('is', 'no')" role="self">view
		<td class="click $self_add:bool('is', 'no')" role="self">add
		<td class="click $self_edit:bool('is', 'no')" role="self">edit
		<td class="grey">rm
		<td class="click is" role="valid">$valid:join(", ")
		<td class="click oh $sql:eq($install):bool('is', 'no')">{% if $sql:ne($install) %}$"<!--":raw
			<table>
			<tr><th>в файле<td>$install
			<tr><th>в базе<td>$sql:bool("", "нет")$sql
			</table>
		$"-->":raw{% fi %}
		$sql
		<td class="click $package:bool('is', 'no')">$package
</tbody>
</table>

</center>